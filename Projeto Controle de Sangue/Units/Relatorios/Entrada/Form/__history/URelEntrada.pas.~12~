unit URelEntrada;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.ComCtrls, Vcl.ExtCtrls, Vcl.Buttons;

type
  TFrmRelEntrada = class(TForm)
    PanelData: TPanel;
    GroupBoxDataEntrada: TGroupBox;
    DateTimePickerDataInicial: TDateTimePicker;
    DateTimePickerDataFinal: TDateTimePicker;
    LabelA: TLabel;
    PanelTipo: TPanel;
    GroupBoxTipo: TGroupBox;
    PanelBotoes: TPanel;
    BtnSair: TBitBtn;
    BtnImprimir: TBitBtn;
    BtnVisualizar: TBitBtn;
    EdtTipo: TEdit;
    BtnAddTipo: TBitBtn;
    RadioGroupFiltroTipo: TRadioGroup;
    ListBoxTipo: TListBox;
    PanelGrupoSanguineo: TPanel;
    GroupBoxGrupoSanguineo: TGroupBox;
    EdtGrupoSanguineo: TEdit;
    BtnAddGrupoSanguineo: TBitBtn;
    RadioGroupFiltroGrupoSanguineo: TRadioGroup;
    ListBoxGrupoSanguineo: TListBox;
    PanelVolume: TPanel;
    GroupBoxVolume: TGroupBox;
    EdtVolume: TEdit;
    BtnAddVolume: TBitBtn;
    RadioGroupFiltroVolume: TRadioGroup;
    ListBoxVolume: TListBox;
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure FormDestroy(Sender: TObject);
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure BtnSairClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure RadioGroupFiltroTipoClick(Sender: TObject);
    procedure BtnAddTipoClick(Sender: TObject);
  private
    FForeignFormKey: SmallInt;
    FCodUsu: Integer;

    procedure RadioGroupClickGeral(const pRADIOGROUP: TRadioGroup; const pLISTBOX: TListBox; const pEDT: TEdit;
      const pBTN: TBitBtn);

    procedure BtnAddClickGeral(const pRADIOGROUP: TRadioGroup; const pLISTBOX: TListBox; const pGROUPBOX: TGroupBox;
      const pEDT: TEdit; const pBTN: TBitBtn);

  public
    class function getRelEntrada(const pFOREIGNFORMKEY: SmallInt; const pCOD_USU: Integer): Boolean;
  end;

var
  FrmRelEntrada: TFrmRelEntrada;

implementation

uses UBiblioteca, UClassMensagem, System.DateUtils;

{$R *.dfm}
{ TFrmRelEntrada }

procedure TFrmRelEntrada.BtnAddClickGeral(const pRADIOGROUP: TRadioGroup; const pLISTBOX: TListBox;
  const pGROUPBOX: TGroupBox; const pEDT: TEdit; const pBTN: TBitBtn);
var
  lTexto: string;
begin

  if (not Trim(pEDT.Text).IsEmpty) then
  begin

    pLISTBOX.Items.Add(pEDT.Text);

    pEDT.Clear;

    if (pRADIOGROUP.ItemIndex = 0) and (pLISTBOX.Items.Count = 2) then
    begin

      pEDT.Enabled := False;
      pBTN.Enabled := False;

    end;

  end
  else
  begin

    lTexto := Format(TMensagem.getMensagem(3), [pGROUPBOX.Caption]);

    // Não da certo.
    // Application.MessageBox( ltexto, '', MB_OK + MB_ICONINFORMATION );
    MessageDlg(lTexto, mtInformation, [mbOK], 0);

  end;

end;

procedure TFrmRelEntrada.BtnAddTipoClick(Sender: TObject);
begin

  Self.BtnAddClickGeral(RadioGroupFiltroTipo, ListBoxTipo, GroupBoxTipo, EdtTipo, BtnAddTipo);

end;

procedure TFrmRelEntrada.BtnSairClick(Sender: TObject);
begin

  Close;

end;

procedure TFrmRelEntrada.FormClose(Sender: TObject; var Action: TCloseAction);
begin

  TBiblioteca.GravaArquivoIni('cnfConfiguracoes.ini', 'IndexRadioGroup', 'FrmRelEntrada.RadioGroupFiltroTipo',
    RadioGroupFiltroTipo.ItemIndex.ToString);

  TBiblioteca.GravaArquivoIni('cnfConfiguracoes.ini', 'IndexRadioGroup', 'FrmRelEntrada.RadioGroupFiltroGrupoSanguineo',
    RadioGroupFiltroGrupoSanguineo.ItemIndex.ToString);

  TBiblioteca.GravaArquivoIni('cnfConfiguracoes.ini', 'IndexRadioGroup', 'FrmRelEntrada.RadioGroupFiltroVolume',
    RadioGroupFiltroVolume.ItemIndex.ToString);

  Action := caFree;

end;

procedure TFrmRelEntrada.FormDestroy(Sender: TObject);
begin

  FrmRelEntrada := nil;

end;

procedure TFrmRelEntrada.FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin

  if (Key = VK_ESCAPE) then
  begin
    BtnSairClick(Sender);
  end;

end;

procedure TFrmRelEntrada.FormShow(Sender: TObject);
begin

  DateTimePickerDataInicial.DateTime := TBiblioteca.getPrimeiroDiaMes(Now);
  DateTimePickerDataFinal.DateTime := TBiblioteca.getUltimoDiaMes(Now);

  RadioGroupFiltroTipo.ItemIndex := TBiblioteca.LeArquivoIni('cnfConfiguracoes.ini', 'IndexRadioGroup',
    'FrmRelEntrada.RadioGroupFiltroTipo', '3').ToInteger;

  RadioGroupFiltroGrupoSanguineo.ItemIndex := TBiblioteca.LeArquivoIni('cnfConfiguracoes.ini', 'IndexRadioGroup',
    'FrmRelEntrada.RadioGroupFiltroGrupoSanguineo', '3').ToInteger;

  RadioGroupFiltroVolume.ItemIndex := TBiblioteca.LeArquivoIni('cnfConfiguracoes.ini', 'IndexRadioGroup',
    'FrmRelEntrada.RadioGroupFiltroVolume', '3').ToInteger;

end;

class function TFrmRelEntrada.getRelEntrada(const pFOREIGNFORMKEY: SmallInt; const pCOD_USU: Integer): Boolean;
begin

  if (FrmRelEntrada = nil) then
  begin

    Application.CreateForm(TFrmRelEntrada, FrmRelEntrada);

  end;

  try

    FrmRelEntrada.FForeignFormKey := pFOREIGNFORMKEY;
    FrmRelEntrada.FCodUsu := pCOD_USU;

    FrmRelEntrada.WindowState := wsNormal;
    FrmRelEntrada.BringToFront;
    FrmRelEntrada.Show;

    Result := True;

  except
    on E: Exception do
    begin
      Result := False;
      raise Exception.Create(Format(TMensagem.getMensagem(0), ['de relatório de entrada', E.Message]));
    end;
  end;

end;

procedure TFrmRelEntrada.RadioGroupClickGeral(const pRADIOGROUP: TRadioGroup; const pLISTBOX: TListBox;
  const pEDT: TEdit; const pBTN: TBitBtn);
var
  lCount: Integer;
begin

  if (pRADIOGROUP.ItemIndex = 0) and (pLISTBOX.Count >= 2) then
  begin

    // Começa do 1 pra não pegar o primeiro registro.
    for lCount := 1 to pLISTBOX.Count - 1 do
    begin

      // Tratamento pra não deletar o ultimo registro.
      if (lCount < pLISTBOX.Count - 1) then
      begin

        pLISTBOX.Items.Delete(lCount);

      end;

    end;

    pEDT.Enabled := False;
    pBTN.Enabled := False;

  end
  else
  begin

    pEDT.Enabled := True;
    pBTN.Enabled := True;

  end;

end;

procedure TFrmRelEntrada.RadioGroupFiltroTipoClick(Sender: TObject);
begin

  Self.RadioGroupClickGeral(RadioGroupFiltroTipo, ListBoxTipo, EdtTipo, BtnAddTipo);

end;

end.
